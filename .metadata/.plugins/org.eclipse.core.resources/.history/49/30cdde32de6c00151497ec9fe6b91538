package lycus;

import java.util.ArrayList;

import org.json.simple.JSONObject;

import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import com.google.gson.JsonArray;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;

public class MemoryDump implements Runnable {
	
	private RunnableProbesHistory history;
	private Gson gson;
	public MemoryDump(RunnableProbesHistory history) {
		super();
		this.history=history;
		this.setGson(new GsonBuilder().create());
	}

	public RunnableProbesHistory getHistory() {
		return history;
	}

	public void setHistory(RunnableProbesHistory history) {
		this.history = history;
	}

	public Gson getGson() {
		return gson;
	}

	public void setGson(Gson gson) {
		this.gson = gson;
	}

	@Override
	public void run() {
		String rollups=this.serializeRollups(this.getAllRollups());
		if(this.getHistory().getRetrieveExistingRollupsCounter()==-1)//check if existing rollups pulled from API, only after pull it push
		{
			SysLogger.Record(new Log("Sending MEMDUMP of rollups to DB...",LogType.Debug));
			ApiStages.insertExistingRollups(rollups);
		}
		}
	private ArrayList<DataPointsRollup[][]> getAllRollups()
	{
		ArrayList<DataPointsRollup[][]> dataRollups=new ArrayList<DataPointsRollup[][]>();
		ArrayList<RunnableProbeResults> historyResults=new ArrayList<RunnableProbeResults>(this.getHistory().getResults().values());
		for(RunnableProbeResults results:historyResults)
		{
			dataRollups.add(results.retrieveExistingRollups());
		}
		return dataRollups;
	}
	private String serializeRollups(ArrayList<DataPointsRollup[][]> rollups)
	{
		return GeneralFunctions.Base64Encode(gson.toJson(rollups));
	}
	public ArrayList<DataPointsRollup[][]> deserializeRollups(String rollups)
	{
		ArrayList<DataPointsRollup[][]> allRollupsDeserialized=new ArrayList<DataPointsRollup[][]>();
		try{
		String decoded=GeneralFunctions.Base64Decode(rollups);
		System.out.println(decoded);
		JsonParser parser = new JsonParser();
		JsonElement jelement=parser.parse(decoded);
		JsonArray allRollups=jelement.getAsJsonArray();
		for(int i=0;i<allRollups.size();i++)
		{
			JsonArray singleProbeRollups=allRollups.get(i).getAsJsonArray();
			DataPointsRollup[][] probeRollups=new DataPointsRollup[singleProbeRollups.size()][6];
			for(int j=0;j<singleProbeRollups.size();j++)
			{
				JsonArray singleProbeResultRollups=singleProbeRollups.get(j).getAsJsonArray();
				for(int z=0;z<6;z++)
				{
					probeRollups[j][z]=gson.fromJson(singleProbeResultRollups.get(z), DataPointsRollup.class);
				}
			}
			allRollupsDeserialized.add(probeRollups);
		}
		}
		catch(Exception e)
		{
			e.printStackTrace();
			System.out.println("flag");
		}
		System.out.println("flag");
//		DataPointsRollup objects=gson.fromJson(jarray.get(0).getAsJsonArray().get(0).getAsJsonArray().get(0), DataPointsRollup.class);
		System.out.println("flag");
		
//		String[] s=objects.get(0)[0];
//		System.out.println(objects.get(0));
		return null;
	}
}
